%%This is a very basic article template.
%%There is just one section and two subsections.
\documentclass{article}
\usepackage[a4paper, margin=2.5cm]{geometry}
\usepackage{amsmath}
\usepackage{mathtools}
\usepackage{amssymb}
\usepackage{caption}
\usepackage{placeins}
\usepackage{graphicx}
\usepackage{subcaption}
\usepackage{setspace}
\usepackage{float}
\usepackage{wrapfig}
\usepackage{pdfpages}
%\usepackage[active,tightpage]{preview}
\usepackage{natbib}
\bibpunct{(}{)}{,}{a}{}{;} 
\usepackage{url}
\usepackage{nth}
\usepackage{authblk}
\usepackage{blindtext}
\usepackage{makecell}

% \renewcommand\theadalign{bc}
% \renewcommand\theadfont{\bfseries}
% \renewcommand\theadgape{\Gape[4pt]}
% \renewcommand\cellgape{\Gape[4pt]}
\DeclarePairedDelimiter\floor{\lfloor}{\rfloor}
% for the d in integrals
\newcommand{\dd}{\; \mathrm{d}}
\newcommand{\tc}{\quad\quad\text{,}}
\newcommand{\tp}{\quad\quad\text{.}}
\newcommand{\ra}{\rightarrow}
\def\lsub#1#2%
  {\mathop{}%
   \mathopen{\vphantom{#2}}_{#1}%
   \kern-\scriptspace%
   #2}
\def\lsup#1#2%
  {\mathop{}%
   \mathopen{\vphantom{#2}}^{#1}%
   \kern-\scriptspace%
   #2}

\defcitealias{HMD}{HMD}
\defcitealias{HFD}{HFD}
\newcommand\ackn[1]{%
  \begingroup
  \renewcommand\thefootnote{}\footnote{#1}%
  \addtocounter{footnote}{-1}%
  \endgroup
}
\newcommand\todo[1]{\textcolor{red}{[TODO: #1]}}
\newcommand\high[1]{\colorbox{yellow}{#1}}
\begin{document}

%  Research note, up to 3,500 words.
% presently ca 2400 not including appendix.
\title{Boom, echo, pulse, flow\\ \small (Open version)}
\author[1]{Tim Riffe\thanks{riffe@demogr.mpg.de}}
\author[1]{Kieron Barclay}
\author[1]{Christina Bohk-Ewald}
\author[2]{Sebastian Kl\"usener}
\affil[1]{Max Planck Institute for Demographic Research}
\affil[2]{Bundesinstitut f\"ur Bev\"olkerungsforschung}
\maketitle

\begin{abstract}
Human population renewal starts with births. Since births can happen at any
time in the year and over a wide range of ages, demographers typically imagine
the birth series as a continuous flow. Taking this construct literally, we
visualize the Swedish birth series as a flow. A long birth series allows us to
juxtapose the children born in a particular year with the children that
they in turn had over the course of their lives, yielding a crude notion of
cohort replacement. Macro patterns in generational growth define the meandering
path of the flow, while temporal booms and busts echo through the flow with the
regularity of a pulse.
\vspace{1em}

{\bf Keywords:} Fertility, Population structure, Population momentum, Population renewal, Data visualization
\end{abstract}

\onehalfspacing
\section{Introduction}
Usually demographers think of fertility as an age-regulated process. In any case it is
bounded by menarche and menopause, both of which are anchored to age. These anchors may
move, but not far or fast. And between these bounds, at least within acceptably homogeneous subpopulations, fertility patterns appear to conform to some regular schema. Since births can happen at any time throughout the year, and since demography usually deals in large numbers, it is common to imagine the birth flow as a continuous stream. This is so not only as a pragmatic assumption to allow for calculus, but it also gives us a heuristic understanding of fertility as a smoother of population structure \citep{arthur1982ergodic}. In the present exposition, we retreat from rates, the material of projections and stable theory, to the absolute number of babies born, the raw material of population renewal. 

We aim to represent a historical view of Sweden's historical birth series in a single multilayered visualization. The birth series is rendered as a flow, in such a way as to be suggestive of novel analytic perspectives, and to invite newcomers and curious minds deeper into the discipline of demography. This image entails investment from the viewer, and this manuscript serves as a protracted legend and caption. Intellectual payoffs include a simultaneous sense of long term patterns of generational mixing and generational replacement, medium term baby booms and echos, and the short term shocks of population momentum. We challenge more experienced demographers to relate this image to the Lexis diagram, to imagine how the picture would change if fertility were indexed to fathers' age, or to reimagine this image of aggregates as an immense set of lineages.

 This series is augmented by a projection of the completed fertility of cohorts through 2016, bringing the lastest year of birth to 2071. The temporal spread from the earliest mother cohort in our final data set (1687) to the latest offspring cohort (2071) is 385 years. We describe our input data and adjustments to it briefly in Sec.~\ref{sec:data}, and in a detailed appendix, which serves as an annotation to the open code repository.

\section{Data and methods}
\label{sec:data}
We use birth count data from Sweden in single-year bins by year of ocurrence and mother cohort, covering a total of 281 occurrence years from 1736 to 2016. Birth counts for years 1736 to 1750 are reconstructed from a variety of sources \citep{HFC, HMD, sweden1969historisk} using indirect methods (see App.~\ref{app:retroject}). Data for years 1751-1774 are derived via adjustment from HFC estimates and HMD exposures and birth totals (see App.~\ref{sec:hfc}). Data for the period 1775 to 1890 come from \citet{sgf1907}, which we have graduated (see App.~\ref{sec:sgf}). The merged birth count series for years 1736 to 1890 is subject to a global adjustment to retain information on cohort size in patterns of cohort fertility (see App.~\ref{sec:histadj}). Data for the years 1891 to 2016 is taken directly from the \citet{HFD} without further adjustment. To complete our picture, we project the fertility of cohorts whose fertility careers were still incomplete as of 2016 (1962-2016) through age 55 (see App.~\ref{sec:proj}). These steps are fully reproducible, and further details can be found in an open data and code repository.\footnote{The reproducibility repository will either be \texttt{github} or \texttt{OSF}, to be determined.}

\section{Age and cohort-structured birth count distributions}
A picture of the births in a year is for demographers most instinctively broken down by the age of mothers who gave birth in that year, Fig.~\ref{fig:agemother}, or by the year of birth of mothers Fig.~\ref{fig:cohmother}. These two distributions are essentially identical, but appear as mirror images if chronological time is enforced in $x$.

\begin{figure}[ht!]
\begin{subfigure}[t]{0.5\textwidth}
        \centering
        \includegraphics[width=\textwidth]{Figures/Fig11900MotherAge.pdf}
        \caption{Births in 1900 by age of mother}
        \label{fig:agemother}
\end{subfigure}
~
\begin{subfigure}[t]{0.5\textwidth}
        \centering
        \includegraphics[width=\textwidth]{Figures/Fig11900MotherCohort.pdf}
        \caption{Births in 1900 by year of birth of mother}
          \label{fig:cohmother}
\end{subfigure}
\caption{Births in a year structured by mothers' age versus mothers' year of birth are a
reflection over $y$ and shift over $x$. Count distributions such as this may be jagged, even if the underlying rate distributions are smooth, due to population structure. The deficit around age 31 in \ref{fig:agemother} is due to a smaller number of potential mothers: the 1871 birth cohort was smaller than the surrounding cohorts.}
\end{figure}

If one disposes of a long-enough time series of births classified by mothers' year of birth, then one may further examine and break down the full reproductive career of the cohort of individuals born in a particular year, assuming no effects of migration. Since the childbearing of a cohort is spread over a synchronous span of ages and years, the classification by age (Fig.~\ref{fig:age1900mother}) or year (Fig.~\ref{fig:year1900}) yields identical and redundant distributions.

\begin{figure}[ht!]
\begin{subfigure}[t]{0.5\textwidth}
        \centering
        \includegraphics[width=\textwidth]{Figures/Fig11900IDAge.pdf}
        \caption{Births from mothers born in 1900 by age of mother}
        \label{fig:age1900mother}
\end{subfigure}
~
\begin{subfigure}[t]{0.5\textwidth}
        \centering
        \includegraphics[width=\textwidth]{Figures/Fig11900IDYear.pdf}
        \caption{Births from mothers born in 1900 by year}
          \label{fig:year1900}
\end{subfigure}
\caption{Births of a cohort structured by mothers' age versus mothers' year of birth are a
shift over $x$. The births over the life of a cohort more often resemble the smoothness of fertility rate schedules,}
\end{figure}

The births in a year are classified by mothers' cohort, i.e. cohort \emph{origins} in Fig.~\ref{fig:cohmother}, whereas the births \emph{from} a cohort are classified \emph{to} time in Fig.~\ref{fig:year1900}. The two distributions are different in kind, but relatable and both on a common scale. A fuller representation of their relationship would place them as two disjoint distributions on the same timeline, as in Fig~\ref{fig:juxt}.

\begin{figure}[ht!]
 \centering
        \includegraphics[width=\textwidth]{Figures/Fig31900juxt.pdf}
        \caption{The cohort distribution of mothers who gave birth in 1900 and the births from mothers born in 1900 by year. These two distributions link three generations.}
          \label{fig:juxt}
\end{figure}

The two distributions in Fig.~\ref{fig:juxt} are related, and of comparable scale, but different in kind. The $x$ coordinate of the left distribution is indexed to mothers' birth cohort, whereas the $x$ coordinate of the right distribution is indexed to child cohort, occurrence year. In this way the respective $x$ coordinates are two generations apart, relating to each other as grandmothers and grandchildren, where the \emph{ego} generation is 1900. These are two quantities that we may wish to compare in various ways to get a better feel and understanding of the Swedish birth series. 

For the case of these Swedish data, we have 281 such distribution pairs, making single-axis rendering impractical. An honest attempt might look like Fig.~\ref{fig:reflect1}, where we reflect the Fig.~\ref{fig:juxt} left distribution over $y$ (\textbf{A}), keeping the Fig.~\ref{fig:juxt} right-side distribution on top (\textbf{B}). These two distributions are linked by the year 1900, which of course overlaps with neither of them. In this representation, \textbf{A} and \textbf{B} are re-drawn for each possible ego year (1775-2016), and therefore imply a large sequential set of overlapping distributions. Each \nth{20} distribution is highlighted, but despite attempts to make this graph legible, i) the high degree of overlapping and ii) the spatial dissociation of each \textbf{A} --- \textbf{B} pair makes the intended comparison difficult over the series.

\begin{figure}[ht!]
 \centering
        \includegraphics[width=\textwidth]{Figures/FxFlowReflect.pdf}
        \caption{Two time series of birth count distributions. The top series is composed of offspring distributions of mother cohorts over time, indexed to occurrence years. The bottom series is composed of the offspring of a year indexed to mothers' birth cohorts. \textbf{B} is the offspring of mothers from the 1900 cohort indexed in $x$ to occurrence year, and \textbf{A} are the births occurred in 1900 indexed in $x$ to mothers' birth cohorts. The cross-section \textbf{a} gives \textbf{A} and the cross-section \textbf{b} gives \textbf{B}.}
          \label{fig:reflect1}
\end{figure}

Fig.~\ref{fig:reflect1} produces at least two noteworthy artifacts that we may wish to preserve and clarify. 1) First order differences in the top series appear to cascade into the lower series--- This derives from a specific kind of population momentum \citep{keyfitz1971momentum}: larger cohorts have more offspring than smaller neighboring cohorts and vice versa, sudden fertility rate changes notwithstanding. 2) The composition of \textbf{A} in the bottom series is implied by the cross-section \textbf{a} of the top series, and the composition of \textbf{B} is implied by the cross-section \textbf{b}. This observation deserves further elaboration: The curve \textbf{A} is composed of all the births in 1900 indexed \emph{back} to mothers' cohorts. Each point on the curve \textbf{A} comes from a different top-axis distribution as it crosses the year 1900 (and vice versa for the bottom). The cross-section of curves \textbf{a} is therefore a redundant encoding of the single highlighted curve \textbf{A}. The cross-section \textbf{b} is a redundant encoding of \textbf{B} in the same way. While \textbf{A} and \textbf{B} are disjoint, and difficult to relate, \textbf{a} and \textbf{b} share a single $x$ coordinate, and so may lend themselves to comparison. The ``problem'' with the cross-sections \textbf{a} and \textbf{b} is that points from the corresponding distributions \textbf{A} and \textbf{B} are overlapped due to collapsation on a single $x$ coordinate. It is basically impossible to work out what \textbf{A} (\textbf{B}) might look like if presented only with \textbf{a} (\textbf{b}) and its surroundings. 
% Q: should the 'pointers' for a and b actually be drawn on top of the data series, as of a cross-section?
\pagebreak
% text above pushes whole thing down
\begin{wrapfigure}{r}{0.5\textwidth}
 \centering
        \includegraphics[width=3in]{Figures/FigReflection.pdf}
        \caption{The 1900 cohort as a composite bar with its offspring reflected over $y$. The size of each bar stacked in the top composition is proportional to the area of its corresponding polygon in the left distribution of Fig.~\ref{fig:juxt}. The size of each bar stacked in the lower composition is proportional to the area of its corresponding polygon in the right distribution of Fig.~\ref{fig:juxt}.}
          \label{fig:refl}
\end{wrapfigure}
% text under goes to the left then builds down
In this way the two distributions that we might wish to compare for a given ego year are already available at a like coordinate, but comparison is stifled by overplotting. If instead we stack the slices that are indecipherably overlapped in \textbf{a} (and likewise for \textbf{b}) we get something like that shown in Fig.~\ref{fig:refl}, cumulative birth distributions.\footnote{Young mothers are on top and older mothers on bottom for both distributions. It would also make sense to plot increasing (or decreasing) ages emanating out from the centerline in both directions.} Here the total bar length is proportional to the total cohort (offspring) size, and stacked bins reflect 5-year mother cohorts (occurrence years). From this representation it is clear that mothers born in the 20 years between 1860 and 1880 produced the bulk of the 1900 cohort (86\%), which itself produced the majority of its offspring in the 20 years between 1920 and 1940 (90\%). It is also quite visible that the 1900 cohort did not replace itself in a crude sense: 138,139 babies formed a cohort whose mothers gave birth to 95,379 babies over their lifecourse, a crude replacement of 69\%. Other perspectives on reproduction that account for survival and attrition or growth of the mother cohort through migration would give a more optimistic assessment \citep{henry1965reflexions}. The key feature of Fig.~\ref{fig:refl} is that the two distributions that were disjoint in Fig.~\ref{fig:juxt} and hard to pick out in Fig.~\ref{fig:reflect1} can now be associated at a common $x$ coordinate. This virtue allows us to view the time series of Fig.~\ref{fig:reflect1} with greater clarity and hopefully reveal some macro properties of the history of Swedish natality.

Fig.~\ref{fig:foldout} is a depiction of the exercise of Fig.~\ref{fig:refl}, cohort bars on top reflected with offspring bars on the bottom. Equal bounded bins from Fig.~\ref{fig:refl} are joined into continuous regions. For the top region, filled polygons represent the births of mothers from quinquennial cohorts, spread over time. For the bottom region, filled polygons represent the mother-cohort origins (in $x$) of the births in quinquennial periods. Color darkness is proportional to the standard deviation of the birth distribution in each stacked polygon, with darker areas indicating more compact and lighter/brighter areas indicate wider distributions.

The meandering baseline of Fig.~\ref{fig:foldout} is proportional to a smoothed time series of the crude cohort replacement rate (see App.~\ref{sec:baseline}). We overlay a horizontal line to indicate periods of growth, replacement, and contraction. Periods where the meandering $x$-baseline is above this line (until ca 1865) indicate crude growth, and periods below the horizontal reference line (ca 1870 to 1930) indicate crude generation contraction. We call this crude replacement because the ratio takes no account of mortality or migration. The twentieth century was characterized by steady replacement by this measure.

To aid the viewer with interpretation, we overlay a lineage of five female generations, a subset of the ancestors and descendants of Alva Myrdal (born Reimer), who as much as anyone ought to remind us of the endogenous forces in the flow we depict.\footnote{This descendancy continues, but births beyond Sissela are not depicted, and we were unable to ascertain the ancestors of Anna Lisa.} Since the top and bottom portions of the graph are alternative depictions of the same data, each member of this lineage appears twice: once below her mother at the same $x$ position, and once again on the top axis $x$-indexed to the year of birth. 

\begin{figure}
\centering
[fold-out figure 4$\times$a4 paper size at 100\% in separate pdf, about here.]
\includegraphics[scale=.3]{Figures/a4demonstration.png}
%\includegraphics[scale=.9]{Figures/SwedenBirthFlowsManFoldout.pdf}
%\includepdf[landscape]{Figures/SwedenBirthFlowsManFoldout.pdf}
\caption{A time series of the same graphical construct as presented in Fig.~\ref{fig:refl}. The $x$ axis now meanders proportional to a smoothed time series of the crude cohort replacement ratio. Fill color darkness is proportional to the standard deviation of the time spread of each birth count distribution: Darker colors indicate more concentrated birth distributions and light colors indicate wider distributions. The birth series now appears as a flow, but reveals echoes in cohort and offspring size, a strong periodic series of booms and busts in recent decades, and a long term dampening of the crude replacement rate. Five generations of a female lineage is annotated atop to serve as a guide.}
\label{fig:foldout}
\end{figure}

%\subsection{Notes on visual form}
%This visualization form derives from stacked area charts in general and river plots (theme river) and stream graphs in particular \citep{byron2008stacked}, but we wish to point out a few notable differences. Our birth flow visualization is composed of two separate stacked area graphs, where polygons appear in chronological order from left to right. If the top and bottom graph sections were vertically centered independently of one another, then these would comprise two ``river'' plots. Instead, the two series are squeezed together to share a $y$ coordinate at 0 on the baseline, and vertical centering is approximated on average by smooth baseline shifts as a function of the crude replacement ratio. 

%Different kinds of visual analytic tasks are probably penalized by this choice of form. For example, using the metrics proposed by \citet{thudt2016assessing}, we hypothesize that our visualization would perform poorly or moderately well in terms of ``individual discrimination'' because most birth distributions vary within the same order of magnitude. For example, it is not easy to visually discriminate the larger of ``number of children born in 1900 to mothers born between 1865 and 1869'' versus ``number of children that mothers born in 1900 had between the years 1925 and 1929'', (even though these share an $x$ coordinate) and such comparisons may be even more difficult the greater the distance in $y$ and $x$ between comparisons. 

%If we wish to compare the area of polygons, our reflected axes are advantageous: for example, it is not easy to visually compare the area of the top-level polygon ``children to mothers born 1870-1874'' versus the area of the bottom-level polygon ``children born 1910-1914''. The darkness and saturation of polygon fill colors transmit this information, but the two fill colors are too similar to be very helpful in this case, especially since they are non-adjacent. However, these two polygons are redundantly encoded in a more comparable way: the first is coded to the average from 1870-1874 of the total height on the bottom $y$ axis, and the second is encoded to the average total height from 1910-1914 on the top $y$ axis. This requires active decoding from the viewer, and such tasks are surely not quick, but likely result in precise judgments: Using height to decode, we see determine that the first polygon is larger than the second. For this kind of comparison, the polygons themselves are a distraction, as the same information is coded the height, but if there were no polygons then we would not be reminded that these two distributions are linked through time and through generations: the polygons overlap in $x$, and this is one of the prime data qualities that we wish to exemplify.

%Again using the metrics of \citet{thudt2016assessing}, we presume to fare \emph{very} well in terms of ``stream comparison'', since the rendering of each birth distribution is matched to $x$, and also \emph{very} well in terms of aggregate discrimination of top versus bottom (because the meandering baseline gives this). Our visualization would presumably perform moderately well in terms of aggregate discrimination of top plus bottom, because river and stream plots also performed well on this metric, and our visualization resembles these in its manner of centering. In our case, the stream centering method brings the crude replacement ratio to the fore. On the other hand, certain visual tasks are augmented due to the nature of the data: visual discrimination of polygons is all but guaranteed. Chronological order is clear to the viewer. Even so, we accept high losses of value look-up ability, for the sake of an aesthetic welcome mat to those who wish to learn more about the fundamentals of demography in general and the Swedish birth flow in particular. Few small questions can be answered with this graphic, but some large ones may be inspired.

\section{Discussion}
\todo{To be continued...This section and the following analytic perspectives section are only temporary. We probably won't want to introduce new}
Several macro features come to the fore in this visualization. These are either known features of the Swedish birth series, or else merit further study. Echoes, booms, why is boom periodicity a recent phenomenon? Is there a dose-response to vertical reverberation in first derivative (can this be referred to as first or second order?) features.

\subsection{Limitations}
Our measure $\mathbb{R}(c)$ seems to be identical to the BRR \citep{ortega2007birth}.
Migration \citep{hyrenius1951reproduction,ediev2014new}
ORR is the cohort size divided by the average cohort size of mothers \citep{wilson2013migration}

\subsection{Sebastian comments}
One is that period effects seem to act differently in the three “generations”. If 1900 would have been a crisis year, especially younger “grandmothers” might have postponed births to a later year. Whether or not 1900 was a crisis year should be less relevant for when and in which quantity “daughters” of the 1900 cohort are born. Thus, my hunch would be that period effects most strongly affect the middle “generation” as it can only be born in one year. In addition, the effects of crisis conditions when the mother generation is born are likely to be more systematic for the “grandmother” compared to the “daughter” generation.

%The issue of selective migration and conditional survival is briefly mentioned, but would require more discussion in case we stay in the perspective of “generations”. What is nice is that conditionality acts similar in both directions (though the effects of migration and conditional survival are likely to differ in quantity between generations). In order for “mothers” to be born in 1900, the “grandmothers” have to survive and to live in Sweden in 1900. In order to become an female offspring of the 1900 cohort, the “mothers” have to survive and to live in Sweden when giving birth. We should make more clear that this conditionality applies in all what we do. In that sense I also find it a bit confusing that we talk about “crude reproduction”. Perhaps we should rather call this “conditional reproduction” (conditional on survival and place of residence in Sweden at the time of giving birth).

%The interpretation of generation arguments becomes particularly tricky as soon as a country faces substantial in-migration. For the immigrant mothers we lack information on conditional survival up to reproductive ages and the birth year distribution of the grandmothers. This makes statements about grandmaternal lags as in Figure 7 quite hypothetical as the immigrant mothers just contribute the generational length between mothers and daughters. Perhaps it would be safer to stay in the above described conditional thinking which would certainly support the use of the meandering x-baseline in the main plot. If we want to stick to thinking in generations, we might call them “conditional generations”.

%\section{Analytic perspectives}
%\todo{this sort of thing ought to inspire discussion, but the stuff presently in this section may not belong in the paper. If so, then in online supplementary material perhaps, because the viability of the paper ought not depend on it.}
%A few macro patterns can be extracted from the data structure implied by the matrix $\mathbf{B}(c,t)$. 

%\subsection{Analytic vignette 1}
%\input{Sections/Analytic1.tex}

%\subsection{Analytic vignette 2}
%\input{Sections/Analytic2.tex}

%\subsection{Analytic vignette 3}
%\todo{KB suggests highlighting changes in the distribution of maternal age.} This is an interesting take: indeed the outer profiles would end up being the same, but the filled polygons would look different. If we did both at once then it'd make a plaid feel. Worth thought. Age could map to some other color property within polygons? Note: the younger-older gradient isn't reflected over $x$, as chronology is enforced. That is, earlier years of birth of offspring mean young (outside on bottom), but earlier years of birth of mother means old (outside on top). So earlier on the outside moves to later on the inside of the flow, but the younger-older gradient rather follows a down-up pattern within both the top and bottom. So adding age to the picture would require further care. But that's not to say there couldn't be an entirely separate plot of the same data indexed to age. Of the plaid remix of APC, with `younger-to-older' or `older-to-younger' from the baseline outward. 


\FloatBarrier

\singlespacing
\bibliographystyle{plainnat}
  \bibliography{references} 
  
\pagebreak
\begin{appendix}
\input{Sections/Appendices.tex}
\end{appendix}
\end{document}
